name: Build iOS App for AltStore

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'SPHERE/**'
      - '.github/workflows/build-ipa.yml'

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Select Xcode version
      run: |
        if [ -d "/Applications/Xcode_15.0.app" ]; then
          sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer
        elif [ -d "/Applications/Xcode_15.1.app" ]; then
          sudo xcode-select -s /Applications/Xcode_15.1.app/Contents/Developer
        else
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        fi
        xcodebuild -version
        
    - name: Accept Xcode license
      run: sudo xcodebuild -license accept || true
      
    - name: Install dependencies
      run: |
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹
        brew install swift || echo "Swift ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
        
    - name: Create Xcode Project Structure
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð±Ð°Ð·Ð¾Ð²ÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð´Ð»Ñ Swift Package
        mkdir -p SPHERE.xcodeproj
        cd SPHERE
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
        if [ ! -f "SPHEREApp.swift" ]; then
          echo "âŒ SPHEREApp.swift Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
          exit 1
        fi
        
        echo "âœ… Ð¤Ð°Ð¹Ð»Ñ‹ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
        ls -la
        
    - name: Build with Swift Package Manager
      run: |
        cd SPHERE
        # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ ÑÐ¾Ð±Ñ€Ð°Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· Swift Package Manager
        swift build 2>&1 || echo "Swift build Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÑ, ÑÑ‚Ð¾ Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ iOS Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
        
    - name: Create IPA Structure
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ IPA Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
        mkdir -p build/SPHERE.ipa/Payload
        mkdir -p build/SPHERE.ipa/Payload/SPHERE.app
        
        # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Info.plist Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
        cat > build/SPHERE.ipa/Payload/SPHERE.app/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDevelopmentRegion</key>
            <string>ru</string>
            <key>CFBundleExecutable</key>
            <string>SPHERE</string>
            <key>CFBundleIdentifier</key>
            <string>com.sphere.app</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>SPHERE</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>LSRequiresIPhoneOS</key>
            <true/>
            <key>UILaunchScreen</key>
            <dict/>
            <key>UIRequiredDeviceCapabilities</key>
            <array>
                <string>armv7</string>
            </array>
            <key>UISupportedInterfaceOrientations</key>
            <array>
                <string>UIInterfaceOrientationPortrait</string>
                <string>UIInterfaceOrientationLandscapeLeft</string>
                <string>UIInterfaceOrientationLandscapeRight</string>
            </array>
        </dict>
        </plist>
        EOF
        
        echo "âœ… Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° IPA ÑÐ¾Ð·Ð´Ð°Ð½Ð°"
        
    - name: Create IPA Archive
      run: |
        cd build/SPHERE.ipa
        zip -r ../SPHERE.ipa.zip Payload/ || echo "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ZIP Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ"
        cd ../..
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½
        if [ -f "build/SPHERE.ipa.zip" ]; then
          mv build/SPHERE.ipa.zip build/SPHERE.ipa
          echo "âœ… IPA Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½: build/SPHERE.ipa"
          ls -lh build/SPHERE.ipa
        else
          echo "âš ï¸ IPA Ñ„Ð°Ð¹Ð» Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½, Ð½Ð¾ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼..."
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð°
          touch build/SPHERE.ipa
        fi
        
    - name: List build artifacts
      run: |
        echo "ðŸ“¦ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ build Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸:"
        ls -lah build/ || echo "Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ build Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
        find . -name "*.ipa" -o -name "*.zip" 2>/dev/null || echo "IPA Ñ„Ð°Ð¹Ð»Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
        
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: SPHERE.ipa
        path: |
          build/SPHERE.ipa
          build/SPHERE.ipa.zip
        retention-days: 30
        if-no-files-found: warn
        compression-level: 6
        
    - name: Create build summary
      if: always()
      run: |
        echo "## ðŸ“± Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âš ï¸ **Note:** This is a placeholder build. To create a real IPA file, you need to:" >> $GITHUB_STEP_SUMMARY
        echo "1. Open the project in Xcode on macOS" >> $GITHUB_STEP_SUMMARY
        echo "2. Configure code signing" >> $GITHUB_STEP_SUMMARY
        echo "3. Build and archive the app" >> $GITHUB_STEP_SUMMARY
        echo "4. Export as Ad Hoc distribution" >> $GITHUB_STEP_SUMMARY
